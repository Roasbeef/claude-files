# LND with Shared Bitcoin Core (Interop Mode)
#
# This docker-compose runs LND connecting to an EXTERNAL bitcoind instance.
# Use this for interop testing with eclair or other Lightning implementations
# that already have bitcoind running.
#
# Prerequisites:
#   - Another stack (e.g., eclair) must have bitcoind running on localhost:18443
#   - ZMQ must be exposed on localhost:28332 and localhost:28333
#
# Usage:
#   # First, start eclair stack (or any stack with bitcoind)
#   cd ~/.claude/skills/eclair/templates && docker-compose up -d
#
#   # Then start lnd connecting to the shared bitcoind
#   cd ~/.claude/skills/lnd/templates
#   docker-compose -f docker-compose-shared.yml up -d
#
# LND gRPC (from host): localhost:10009
# LND REST (from host): localhost:8080
# LND P2P (from host): localhost:9736 (different from eclair's 9735)

services:
  lnd:
    # Build from local source using dev.Dockerfile
    build:
      context: ${LND_SOURCE:-/users/roasbeef/gocode/src/github.com/lightningnetwork/lnd}
      dockerfile: dev.Dockerfile
    image: ${LND_IMAGE:-lnd:local}
    container_name: lnd-shared
    restart: unless-stopped
    # Use host network to access localhost:18443 (eclair's bitcoind)
    network_mode: host
    environment:
      # Backend configuration - connects to external bitcoind
      - BACKEND=bitcoind
      - RPCHOST=localhost
      - RPCUSER=bitcoin
      - RPCPASS=bitcoin
      - NETWORK=regtest
      - CHAIN=bitcoin
      - LND_DEBUG=${LND_DEBUG:-debug}
      # Custom args
      - LND_EXTRA_ARGS=${LND_EXTRA_ARGS:-}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        exec lnd \
          --noseedbackup \
          --bitcoin.active \
          --bitcoin.regtest \
          --bitcoin.node=bitcoind \
          --bitcoind.rpchost=localhost:18443 \
          --bitcoind.rpcuser=bitcoin \
          --bitcoind.rpcpass=bitcoin \
          --bitcoind.zmqpubrawblock=tcp://localhost:28332 \
          --bitcoind.zmqpubrawtx=tcp://localhost:28333 \
          --listen=0.0.0.0:9736 \
          --rpclisten=localhost:10009 \
          --restlisten=localhost:8081 \
          --debuglevel=$${LND_DEBUG:-debug} \
          $${LND_EXTRA_ARGS:-}
    volumes:
      - lnd-shared-data:/root/.lnd

volumes:
  lnd-shared-data:

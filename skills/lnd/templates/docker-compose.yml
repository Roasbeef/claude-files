# LND + Bitcoin Core Regtest Stack
#
# This docker-compose runs a complete Lightning development environment:
# - Bitcoin Core in regtest mode with ZMQ notifications
# - LND Lightning Network node (built from local source)
#
# NOTE: LND is built from source at the path specified by LND_SOURCE.
# First run will take several minutes to compile.
#
# Ports are exposed to host so other nodes (eclair, c-lightning, etc.)
# can connect to the same backend for interop testing.
#
# Usage:
#   docker-compose up -d --build   # Build and start (first time)
#   docker-compose up -d           # Start stack (after build)
#   docker-compose down            # Stop stack
#   docker-compose down -v         # Stop and remove volumes
#
# Bitcoin Core RPC (from host): localhost:18443
# Bitcoin Core ZMQ (from host): localhost:28332, localhost:28333
# LND gRPC (from host): localhost:10009
# LND REST (from host): localhost:8080
# LND P2P (from host): localhost:9735

services:
  bitcoind:
    image: lightninglabs/bitcoin-core:30
    container_name: lnd-bitcoind
    restart: unless-stopped
    command:
      - -regtest
      - -server=1
      - -rpcuser=devuser
      - -rpcpassword=devpass
      - -rpcallowip=0.0.0.0/0
      - -rpcbind=0.0.0.0
      - -txindex=1
      - -fallbackfee=0.00001
      - -addresstype=bech32m
      - -changetype=bech32m
      - -zmqpubrawblock=tcp://0.0.0.0:28332
      - -zmqpubrawtx=tcp://0.0.0.0:28333
      - -zmqpubhashblock=tcp://0.0.0.0:28332
      - -zmqpubhashtx=tcp://0.0.0.0:28333
    ports:
      # Expose all ports to host for other Lightning nodes
      - "18443:18443"   # RPC port (regtest)
      - "18444:18444"   # P2P port (regtest)
      - "28332:28332"   # ZMQ block notifications
      - "28333:28333"   # ZMQ tx notifications
    volumes:
      - lnd-bitcoind-data:/root/.bitcoin
    networks:
      - lnd-regtest
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-regtest", "-rpcuser=devuser", "-rpcpassword=devpass", "getblockchaininfo"]
      interval: 10s
      timeout: 5s
      retries: 5

  lnd:
    # Build from local source using dev.Dockerfile
    # Set LND_SOURCE env var to use a different source directory
    build:
      context: ${LND_SOURCE:-/users/roasbeef/gocode/src/github.com/lightningnetwork/lnd}
      dockerfile: dev.Dockerfile
    image: ${LND_IMAGE:-lnd:local}
    container_name: lnd
    restart: unless-stopped
    depends_on:
      bitcoind:
        condition: service_healthy
    environment:
      # Backend configuration
      - BACKEND=bitcoind
      - RPCHOST=bitcoind
      - RPCUSER=devuser
      - RPCPASS=devpass
      - NETWORK=regtest
      - CHAIN=bitcoin
      - LND_DEBUG=${LND_DEBUG:-debug}
      # Custom args (space-separated, appended to lnd command)
      - LND_EXTRA_ARGS=${LND_EXTRA_ARGS:-}
    entrypoint: ["./start-lnd.sh"]
    ports:
      - "9735:9735"     # Lightning P2P
      - "10009:10009"   # gRPC
      - "8080:8080"     # REST API
    volumes:
      - lnd-data:/root/.lnd
    networks:
      - lnd-regtest

volumes:
  lnd-bitcoind-data:
  lnd-data:

networks:
  lnd-regtest:
    driver: bridge

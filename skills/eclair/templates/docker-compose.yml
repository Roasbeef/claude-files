# Eclair + Bitcoin Core Regtest Stack
#
# This docker-compose runs a complete Lightning development environment:
# - Bitcoin Core in regtest mode with ZMQ notifications
# - Eclair Lightning Network node (built from local source)
#
# NOTE: Eclair is built from source at /Users/roasbeef/codez/eclair because
# Docker Hub images have a kill switch for old versions. First run will take
# several minutes to compile.
#
# bitcoind ports are exposed to the host so other nodes (lnd, c-lightning, etc.)
# can connect to the same backend.
#
# Usage:
#   docker-compose up -d --build   # Build and start (first time)
#   docker-compose up -d           # Start stack (after build)
#   docker-compose down            # Stop stack
#   docker-compose down -v         # Stop and remove volumes
#
# Bitcoin Core RPC (from host): localhost:18443
# Bitcoin Core ZMQ (from host): localhost:28332, localhost:28333
# Eclair API (from host): localhost:8080
# Eclair Lightning (from host): localhost:9735

services:
  bitcoind:
    image: lightninglabs/bitcoin-core:30
    container_name: bitcoind
    restart: unless-stopped
    command:
      - -regtest
      - -server=1
      - -rpcuser=bitcoin
      - -rpcpassword=bitcoin
      - -rpcallowip=0.0.0.0/0
      - -rpcbind=0.0.0.0
      - -txindex=1
      - -fallbackfee=0.00001
      - -addresstype=bech32m
      - -changetype=bech32m
      - -zmqpubrawblock=tcp://0.0.0.0:28332
      - -zmqpubrawtx=tcp://0.0.0.0:28333
      - -zmqpubhashblock=tcp://0.0.0.0:28332
      - -zmqpubhashtx=tcp://0.0.0.0:28333
      # Auto-create wallet on startup (required for eclair)
      - -wallet=eclair
    ports:
      # Expose all ports to host for other Lightning nodes (lnd, etc.)
      - "18443:18443"   # RPC port (regtest)
      - "18444:18444"   # P2P port (regtest)
      - "28332:28332"   # ZMQ block notifications
      - "28333:28333"   # ZMQ tx notifications
    volumes:
      - bitcoind-data:/root/.bitcoin
    networks:
      - lightning-regtest
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-regtest", "-rpcuser=bitcoin", "-rpcpassword=bitcoin", "getblockchaininfo"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Init service to create bitcoind wallet (runs once, then exits)
  bitcoind-init:
    image: lightninglabs/bitcoin-core:30
    container_name: bitcoind-init
    depends_on:
      bitcoind:
        condition: service_healthy
    restart: "no"
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        bitcoin-cli -regtest -rpcconnect=bitcoind -rpcuser=bitcoin -rpcpassword=bitcoin listwallets | grep -q '"eclair"' || \
        bitcoin-cli -regtest -rpcconnect=bitcoind -rpcuser=bitcoin -rpcpassword=bitcoin createwallet eclair
        echo "Wallet 'eclair' ready"
    networks:
      - lightning-regtest

  eclair:
    # Build from local source (0.14.0-SNAPSHOT) since Docker Hub images have kill switch
    # Set ECLAIR_SOURCE env var to use a different source directory
    build:
      context: ${ECLAIR_SOURCE:-/Users/roasbeef/codez/eclair}
      dockerfile: Dockerfile
    image: ${ECLAIR_IMAGE:-eclair:local}
    container_name: eclair
    restart: unless-stopped
    depends_on:
      bitcoind:
        condition: service_healthy
      bitcoind-init:
        condition: service_completed_successfully
    environment:
      JAVA_OPTS: >-
        -Xmx512m
        -Declair.allow-unsafe-startup=true
        -Declair.chain=regtest
        -Declair.node-alias=eclair-regtest
        -Declair.node-color=49daaa
        -Declair.api.enabled=true
        -Declair.api.password=devpassword
        -Declair.api.binding-ip=0.0.0.0
        -Declair.api.port=8080
        -Declair.bitcoind.host=bitcoind
        -Declair.bitcoind.rpcport=18443
        -Declair.bitcoind.rpcuser=bitcoin
        -Declair.bitcoind.rpcpassword=bitcoin
        -Declair.bitcoind.zmqblock=tcp://bitcoind:28332
        -Declair.bitcoind.zmqtx=tcp://bitcoind:28333
        -Declair.bitcoind.wallet=eclair
        -Declair.printToConsole
    ports:
      - "9735:9735"     # Lightning P2P
      - "8080:8080"     # API
    volumes:
      - eclair-data:/data
    networks:
      - lightning-regtest

volumes:
  bitcoind-data:
  eclair-data:

networks:
  lightning-regtest:
    driver: bridge
